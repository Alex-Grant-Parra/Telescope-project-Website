{% extends "base.html" %}

{% block title %}Interface - Telescope Control{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Main Panel and Take Photo Button Row -->
    <div class="d-flex align-items-start" style="position: relative; height: 80vh;">
        <!-- Main Panel -->
        <div class="main-panel border rounded p-3 position-relative flex-grow-1" id="mainPanel" style="min-width: 0; width: 75vw; height: 100%;">
            <button class="fullscreen-toggle btn btn-danger btn-sm position-absolute top-0 end-0 m-2" onclick="toggleFullscreen()">â›¶</button>
            <h2 class="text-center">Main Panel</h2>
        </div>
    </div>

    <!-- Draggable Camera Controls Panel -->
    <div class="draggable-panel border rounded shadow p-3 bg-white position-absolute" id="cameraPanel" style="top: 100px; left: 20px;">
        <div class="panel-header bg-dark text-white p-2 rounded-top" style="user-select: none;">Camera Controls</div>  <!-- non-selectable title -->
        <div class="control-row d-flex justify-content-between my-2">
            <span>Shutter Speed</span>
            <select id="shutterSpeedSelect" class="form-select form-select-sm" style="width: auto;" onchange="updateSetting()"></select>
        </div>
        <div class="control-row d-flex justify-content-between my-2">
            <span>ISO</span>
            <select id="isoSelect" class="form-select form-select-sm" style="width: auto;" onchange="updateSetting()"></select>
        </div>
        <div class="control-row d-flex justify-content-between my-2">
            <span>Aperture</span>
            <span id="apertureValue">f/2.8</span>
        </div>
        <div class="control-row my-2">
            <label for="whiteBalance">White Balance</label>
            <select class="form-select" id="whiteBalance" onchange="updateSetting()">
                <option>Auto</option>
                <option>Daylight</option>
                <option>Cloudy</option>
                <option>Tungsten</option>
                <option>Fluorescent</option>
            </select>
        </div>
        <div class="control-row my-2">
            <label for="photoFormat">Photo Format</label>
            <select class="form-select" id="photoFormat" onchange="updateSetting()">
                <option>JPEG</option>
                <option>RAW</option>
            </select>
        </div>
        <button id="takePhotoBtn" class="btn btn-primary mt-3 w-100" style="height: 60px; font-size: 1.25rem;" onclick="takePhoto()">ðŸ“· Take Photo</button>
    </div>

    <!-- Draggable Telescope Controls Panel -->
    <div class="draggable-panel border rounded shadow p-3 bg-white position-absolute" id="telescopePanel" style="top: 500px; left: 20px;">
        <div class="panel-header bg-dark text-white p-2 rounded-top" style="user-select: none;">Telescope Controls</div>  <!-- non-selectable title -->
        <div class="control-row my-2">
            <label for="searchObject">Search Object</label>
            <input type="text" class="form-control" id="searchObject" placeholder="Search for object">
            <button class="btn btn-primary mt-2" onclick="searchObject()">Search</button>
        </div>
    </div>

    <!-- Draggable Live View Controls Panel -->
    <div class="draggable-panel border rounded shadow p-3 bg-white position-absolute" id="liveViewPanel" style="top: 100px; left: 80vw; min-width: 220px;">
        <div class="panel-header bg-dark text-white p-2 rounded-top" style="user-select: none;">Live View Controls</div>
        <div class="control-row my-3 d-flex justify-content-between align-items-center">
            <span>Live View</span>
            <button id="liveViewToggleBtn" class="btn btn-outline-primary" onclick="toggleLiveView()">Start</button>
        </div>
    </div>

    <!-- Draggable Telescope Selection Panel -->
    <div class="draggable-panel border rounded shadow p-3 bg-white position-absolute" id="telescopeSelectionPanel" style="top: 300px; left: 80vw; min-width: 250px;">
        <div class="panel-header bg-dark text-white p-2 rounded-top" style="user-select: none;">Telescope Selection</div>
        <div class="control-row my-2">
            <label for="telescopeSelect">Connected Telescopes</label>
            <select id="telescopeSelect" class="form-select" onchange="selectTelescope()">
                <option value="">Select a telescope...</option>
            </select>
        </div>
        <div class="control-row my-2" id="telescopeInfo" style="display: none;">
            <div class="small text-muted">
                <div><strong>ID:</strong> <span id="telescopeId"></span></div>
                <div><strong>IP:</strong> <span id="telescopeIp"></span></div>
                <div><strong>Version:</strong> <span id="telescopeVersion"></span></div>
                <div><strong>Status:</strong> <span id="telescopeStatus"></span></div>
            </div>
        </div>
        <div class="control-row my-2">
            <button class="btn btn-info btn-sm w-100" onclick="refreshTelescopes()">ðŸ”„ Refresh</button>
        </div>
    </div>
</div>

<script>
    // Toggle full screen mode
    function toggleFullscreen() {
        let panel = document.getElementById("mainPanel");
        if (!document.fullscreenElement) {
            panel.requestFullscreen().catch(err => {
                alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    // Make the panels draggable
    document.querySelectorAll(".draggable-panel").forEach(panel => {
        let header = panel.querySelector(".panel-header");
        header.addEventListener("mousedown", (event) => {
            let shiftX = event.clientX - panel.getBoundingClientRect().left;
            let shiftY = event.clientY - panel.getBoundingClientRect().top;

            function moveAt(pageX, pageY) {
                panel.style.left = pageX - shiftX + "px";
                panel.style.top = pageY - shiftY + "px";
            }

            function onMouseMove(event) {
                moveAt(event.pageX, event.pageY);
            }

            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", () => {
                document.removeEventListener("mousemove", onMouseMove);
            }, { once: true });
        });
    });

    // Fetch camera choices and populate dropdowns
    function populateCameraChoices() {
        fetch("{{ url_for('interface.get_camera_choices') }}")
            .then(response => response.json())
            .then(data => {
                // Populate shutter speed
                let shutterSelect = document.getElementById("shutterSpeedSelect");
                shutterSelect.innerHTML = "";
                (data.shutterSpeed || []).forEach(choice => {
                    let opt = document.createElement("option");
                    opt.value = choice;
                    opt.text = choice;
                    shutterSelect.appendChild(opt);
                });

                // Populate ISO
                let isoSelect = document.getElementById("isoSelect");
                isoSelect.innerHTML = "";
                (data.iso || []).forEach(choice => {
                    let opt = document.createElement("option");
                    opt.value = choice;
                    opt.text = choice;
                    isoSelect.appendChild(opt);
                });
            })
            .catch(error => {
                console.error("Failed to fetch camera choices:", error);
            });
    }

    // Call on page load
    document.addEventListener("DOMContentLoaded", function() {
        populateCameraChoices();
        loadTelescopes();
        loadSelectedTelescope();
    });

    // Update settings to backend
    function updateSetting() {
        let data = {
            shutterSpeed: document.getElementById("shutterSpeedSelect").value,
            iso: document.getElementById("isoSelect").value,
            aperture: document.getElementById("apertureValue").innerText,
            whiteBalance: document.getElementById("whiteBalance").value,
            photoFormat: document.getElementById("photoFormat").value
        };
        fetch("{{ url_for('interface.update_camera') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        }).then(response => response.json())
        .then(data => console.log("Response from server:", data))
        .catch(error => console.error("Fetch error:", error));
    }

    function takePhoto() {
        fetch("{{ url_for('interface.take_photo') }}", {
            method: "POST"
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                alert("Photo taken and saved!");
            } else {
                alert("Failed to take photo: " + (data.message || "Unknown error"));
            }
        })
        .catch(error => {
            alert("Error taking photo: " + error);
        });
    }

    // Live View Toggle Logic
    let liveViewActive = false;
    function toggleLiveView() {
        liveViewActive = !liveViewActive;
        const btn = document.getElementById("liveViewToggleBtn");
        btn.textContent = liveViewActive ? "Stop" : "Start";
        btn.classList.toggle("btn-outline-primary", !liveViewActive);
        btn.classList.toggle("btn-outline-danger", liveViewActive);
        // Add your start/stop live view logic here
    }

    // // Function to search for an object
    // function searchObject() {
    //     let searchValue = document.getElementById("searchObject").value;
    //     if (searchValue) {
    //         console.log("Searching for object:", searchValue);
    //         fetch("{{ url_for('interface.search_object') }}", {
    //             method: "POST",
    //             headers: { "Content-Type": "application/json" },
    //             body: JSON.stringify({ searchValue: searchValue })
    //         }).then(response => response.json())
    //         .then(data => console.log("Response from server:", data))
    //         .catch(error => console.error("Fetch error:", error));
    //     } else {
    //         alert("Please enter a valid HD, NGC, or IC number.");
    //     }
    // }


function showStarInfo(star) {
    const existingModal = document.getElementById("starInfoModal");
    if (existingModal) existingModal.remove();

    const modal = document.createElement("div");
    modal.id = "starInfoModal";
    modal.style.position = "fixed";
    modal.style.top = "50%";
    modal.style.left = "50%";
    modal.style.transform = "translate(-50%, -50%)";
    modal.style.background = "black";
    modal.style.color = "white";
    modal.style.padding = "15px";
    modal.style.borderRadius = "8px";
    modal.style.zIndex = 1000;
    modal.style.maxWidth = "300px";
    modal.style.boxShadow = "0 0 10px #fff";

    modal.innerHTML = `
        <h2>${star.name || star.Name}</h2>
        <p><b>RA:</b> ${star.ra !== undefined ? star.ra : star.RA}Â°</p>
        <p><b>DEC:</b> ${star.dec !== undefined ? star.dec : star.DEC}Â°</p>
        <p><b>Magnitude:</b> ${star.mag !== undefined ? star.mag : star["V-Mag"]}</p>
        <button id="trackStarBtn" class="btn btn-success">Track</button>
        <button id="closeStarInfo" class="btn btn-secondary ms-2">Close</button>
    `;

    document.body.appendChild(modal);

    document.getElementById("closeStarInfo").addEventListener("click", () => {
        modal.remove();
    });

    document.getElementById("trackStarBtn").addEventListener("click", () => {
        // Send tracking request to backend
        fetch("/track_star", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                name: star.name || star.Name,
                ra: star.ra !== undefined ? star.ra : star.RA,
                dec: star.dec !== undefined ? star.dec : star.DEC,
                mag: star.mag !== undefined ? star.mag : star["V-Mag"]
            })
        })
        .then(response => response.json())
        .then(data => {
            // alert("Tracking started!");
            modal.remove();
        })
        .catch(error => {
            // alert("Failed to start tracking.");
            console.error(error);
        });
    });
}

function searchObject() {
    let searchValue = document.getElementById("searchObject").value;
    if (searchValue) {
        fetch("{{ url_for('interface.search_object') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ searchValue: searchValue })
        }).then(response => response.json())
        .then(data => {
            if (data.status === "success" && data.data) {
                showStarInfo(data.data);
            } else {
                alert(data.message || "Object not found.");
            }
        })
        .catch(error => console.error("Fetch error:", error));
    } else {
        alert("Please enter a valid HD, NGC, or IC number.");
    }
}

// Telescope selection functions
function loadTelescopes() {
    fetch("{{ url_for('interface.get_telescopes') }}")
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                populateTelescopeDropdown(data.telescopes);
            } else {
                console.error("Failed to load telescopes:", data.message);
            }
        })
        .catch(error => {
            console.error("Error loading telescopes:", error);
        });
}

function populateTelescopeDropdown(telescopes) {
    const select = document.getElementById("telescopeSelect");
    select.innerHTML = '<option value="">Select a telescope...</option>';
    
    telescopes.forEach(telescope => {
        const option = document.createElement("option");
        option.value = telescope.telescopeId;
        option.text = `${telescope.telescopeId} (${telescope.online ? 'Online' : 'Offline'})`;
        option.dataset.telescope = JSON.stringify(telescope);
        select.appendChild(option);
    });
}

function selectTelescope() {
    const select = document.getElementById("telescopeSelect");
    const selectedValue = select.value;
    
    if (!selectedValue) {
        document.getElementById("telescopeInfo").style.display = "none";
        return;
    }
    
    const selectedOption = select.options[select.selectedIndex];
    const telescope = JSON.parse(selectedOption.dataset.telescope);
    
    // Update UI with telescope info
    document.getElementById("telescopeId").textContent = telescope.telescopeId;
    document.getElementById("telescopeIp").textContent = telescope.ipAddress;
    document.getElementById("telescopeVersion").textContent = telescope.firmwareVersion;
    document.getElementById("telescopeStatus").textContent = telescope.online ? 'Online' : 'Offline';
    document.getElementById("telescopeStatus").className = telescope.online ? 'text-success' : 'text-danger';
    document.getElementById("telescopeInfo").style.display = "block";
    
    // Send selection to backend
    fetch("{{ url_for('interface.select_telescope') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telescopeId: selectedValue })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            console.log("Telescope selected:", data.message);
        } else {
            alert("Failed to select telescope: " + data.message);
        }
    })
    .catch(error => {
        console.error("Error selecting telescope:", error);
        alert("Error selecting telescope");
    });
}

function refreshTelescopes() {
    loadTelescopes();
}

function loadSelectedTelescope() {
    fetch("{{ url_for('interface.get_selected_telescope') }}")
        .then(response => response.json())
        .then(data => {
            if (data.status === "success" && data.telescope) {
                // Set the dropdown to show the selected telescope
                const select = document.getElementById("telescopeSelect");
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === data.telescope.telescopeId) {
                        select.selectedIndex = i;
                        selectTelescope(); // Update the info panel
                        break;
                    }
                }
            }
        })
        .catch(error => {
            console.error("Error loading selected telescope:", error);
        });
}


</script>
{% endblock %}