<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3D Planetarium</title>
    <style>
        html, body { margin: 0; padding: 0; overflow: hidden; background: #000; }
        #planetarium { display: block; width: 100vw; height: 100vh; background: #000; }
        #info { position: absolute; top: 10px; left: 10px; color: #fff; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 4px; font-family: sans-serif; z-index: 10; }
        #controls {
            position: absolute; top: 10px; right: 10px; z-index: 20; background: rgba(0,0,0,0.7);
            color: #fff; padding: 12px 16px; border-radius: 6px; font-family: sans-serif;
            display: flex; flex-direction: column; gap: 8px; min-width: 220px;
        }
        #controls label { font-size: 0.95em; }
        #controls input[type="range"] { width: 100px; }
        #controls input[type="number"] { width: 60px; }
        #controls button { margin-top: 4px; }
        #loading {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: #111; color: #fff; display: flex; align-items: center; justify-content: center;
            font-size: 2em; z-index: 100;
        }
        #help-modal {
            display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7); z-index: 200; align-items: center; justify-content: center;
        }
        #help-content {
            background: #222; color: #fff; padding: 24px; border-radius: 8px; max-width: 400px;
            font-family: sans-serif;
        }
        #help-content button { margin-top: 12px; }
    </style>
</head>
<body>
<div id="loading">Loading planetarium...</div>
<canvas id="planetarium"></canvas>
<div id="info">Drag to rotate. Click a star/planet for info.</div>
<div id="controls">
    <label>
        Mag ≤ <span id="mag-value">6</span>
        <input type="range" id="mag-filter" min="-2" max="10" step="0.1" value="6">
    </label>
    <label>
        Latitude:
        <input type="number" id="latitude" min="-90" max="90" step="0.1" value="0">
    </label>
    <label>
        Longitude:
        <input type="number" id="longitude" min="-180" max="180" step="0.1" value="0">
    </label>
    <label>
        <input type="checkbox" id="show-stars" checked> Stars
        <input type="checkbox" id="show-planets" checked> Planets
    </label>
    <button id="reset-view">Reset View</button>
    <button id="help-btn">Help</button>
</div>
<div id="help-modal">
    <div id="help-content">
        <b>3D Planetarium Controls</b><br><br>
        <ul>
            <li>Drag mouse to rotate the sky</li>
            <li>Click a star/planet for info</li>
            <li>Adjust magnitude filter to show/hide faint stars</li>
            <li>Set your latitude/longitude for local sky orientation</li>
            <li>Toggle stars/planets visibility</li>
            <li>Reset view to default orientation</li>
        </ul>
        <button id="close-help">Close</button>
    </div>
</div>
<script type="application/json" id="stars-data">
    {{ stars|tojson }}
</script>
<script>
    // Get star/planet data from Flask
    const stars = JSON.parse(document.getElementById('stars-data').textContent);

    // UI elements
    const magFilter = document.getElementById('mag-filter');
    const magValue = document.getElementById('mag-value');
    const latInput = document.getElementById('latitude');
    const lonInput = document.getElementById('longitude');
    const showStars = document.getElementById('show-stars');
    const showPlanets = document.getElementById('show-planets');
    const resetBtn = document.getElementById('reset-view');
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const closeHelp = document.getElementById('close-help');
    const loading = document.getElementById('loading');

    // Canvas setup
    const canvas = document.getElementById('planetarium');
    const ctx = canvas.getContext('2d');
    let width = window.innerWidth, height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;

    // 3D sphere parameters
    // Increase the sphere radius for a more immersive effect
    const R = Math.min(width, height) * 0.9 / 2;
    let rotX = 0, rotY = 0; // rotation angles
    let dragging = false, lastX = 0, lastY = 0;

    // Camera is inside the sphere: invert z-culling (draw z < 0)
    // Convert RA/DEC to 3D Cartesian coordinates
    function radecToXYZ(ra, dec) {
        // RA in degrees, DEC in degrees
        const raRad = ra * Math.PI / 180;
        const decRad = dec * Math.PI / 180;
        const x = Math.cos(decRad) * Math.cos(raRad);
        const y = Math.sin(decRad);
        const z = Math.cos(decRad) * Math.sin(raRad);
        return [x, y, z];
    }

    // 3D rotation (including local latitude/longitude)
    function rotate([x, y, z], rotX, rotY, lat, lon) {
        // Apply longitude (azimuthal) rotation
        let x1 = x * Math.cos(lon) - z * Math.sin(lon);
        let z1 = x * Math.sin(lon) + z * Math.cos(lon);
        // Apply latitude (altitude) rotation
        let y1 = y * Math.cos(lat) - z1 * Math.sin(lat);
        let z2 = y * Math.sin(lat) + z1 * Math.cos(lat);
        // User rotation (drag)
        let x2 = x1 * Math.cos(rotY) - z2 * Math.sin(rotY);
        let z3 = x1 * Math.sin(rotY) + z2 * Math.cos(rotY);
        let y2 = y1 * Math.cos(rotX) - z3 * Math.sin(rotX);
        let z4 = y1 * Math.sin(rotX) + z3 * Math.cos(rotX);
        return [x2, y2, z4];
    }

    // Project 3D point to 2D canvas (camera at center, looking outward)
    function project([x, y, z]) {
        const fov = 1.5;
        const scale = R / (fov - z); // z > 0 is in front of the camera
        return [
            width / 2 + x * scale,
            height / 2 - y * scale
        ];
    }

    // Draw all stars/planets
    function draw() {
        ctx.clearRect(0, 0, width, height);
        // Draw celestial sphere outline
        ctx.save();
        ctx.strokeStyle = "#333";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(width/2, height/2, R, 0, 2*Math.PI);
        ctx.stroke();
        ctx.restore();

        // Get filter values
        const magLimit = parseFloat(magFilter.value);
        const lat = parseFloat(latInput.value) * Math.PI / 180;
        const lon = parseFloat(lonInput.value) * Math.PI / 180;
        const showStarsVal = showStars.checked;
        const showPlanetsVal = showPlanets.checked;

        // Draw stars/planets
        for (const obj of stars) {
            if (obj.mag > magLimit) continue;
            if (obj.type === "star" && !showStarsVal) continue;
            if (obj.type === "planet" && !showPlanetsVal) continue;
            let [x, y, z] = radecToXYZ(obj.ra, obj.dec);
            [x, y, z] = rotate([x, y, z], rotX, rotY, lat, lon);
            // Only render objects in front of the camera (z > 0)
            if (z <= 0) continue;
            const [cx, cy] = project([x, y, z]);
            let size = obj.type === "planet" ? 8 : Math.max(1, 6 - (obj.mag || 6));
            ctx.save();
            if (obj.type === "planet") {
                if (obj.icon) {
                    let img = new window.Image();
                    img.src = obj.icon;
                    ctx.drawImage(img, cx-size, cy-size, size*2, size*2);
                } else {
                    ctx.fillStyle = "#ff0";
                    ctx.beginPath();
                    ctx.arc(cx, cy, size, 0, 2*Math.PI);
                    ctx.fill();
                }
            } else {
                ctx.fillStyle = "#fff";
                ctx.globalAlpha = Math.max(0.5, 1 - (obj.mag || 6)/8);
                ctx.beginPath();
                ctx.arc(cx, cy, size, 0, 2*Math.PI);
                ctx.fill();
            }
            ctx.restore();
        }
    }

    // Mouse controls
    canvas.addEventListener('mousedown', e => {
        dragging = true;
        lastX = e.clientX;
        lastY = e.clientY;
    });
    window.addEventListener('mousemove', e => {
        if (!dragging) return;
        rotY += (e.clientX - lastX) * 0.01;
        rotX += (e.clientY - lastY) * 0.01;
        rotX = Math.max(-Math.PI/2, Math.min(Math.PI/2, rotX));
        lastX = e.clientX;
        lastY = e.clientY;
        draw();
    });
    window.addEventListener('mouseup', () => dragging = false);

    // Click to show info
    canvas.addEventListener('click', function(e) {
        const mx = e.clientX, my = e.clientY;
        const magLimit = parseFloat(magFilter.value);
        const lat = parseFloat(latInput.value) * Math.PI / 180;
        const lon = parseFloat(lonInput.value) * Math.PI / 180;
        for (const obj of stars) {
            if (obj.mag > magLimit) continue;
            if (obj.type === "star" && !showStars.checked) continue;
            if (obj.type === "planet" && !showPlanets.checked) continue;
            let [x, y, z] = radecToXYZ(obj.ra, obj.dec);
            [x, y, z] = rotate([x, y, z], rotX, rotY, lat, lon);
            if (z <= 0) continue;
            const [cx, cy] = project([x, y, z]);
            let size = obj.type === "planet" ? 8 : Math.max(1, 6 - (obj.mag || 6));
            if ((mx-cx)**2 + (my-cy)**2 < size*size*2) {
                document.getElementById('info').innerHTML =
                    `<b>${obj.name}</b><br>RA: ${obj.ra.toFixed(2)}°<br>DEC: ${obj.dec.toFixed(2)}°<br>Mag: ${obj.mag}`;
                return;
            }
        }
        document.getElementById('info').innerHTML = "Drag to rotate. Click a star/planet for info.";
    });

    // Responsive resize
    window.addEventListener('resize', () => {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        draw();
    });

    // Preload planet icons
    for (const obj of stars) {
        if (obj.icon) {
            let img = new window.Image();
            img.src = obj.icon;
        }
    }

    // UI event listeners
    magFilter.addEventListener('input', () => {
        magValue.textContent = magFilter.value;
        draw();
    });
    latInput.addEventListener('change', draw);
    lonInput.addEventListener('change', draw);
    showStars.addEventListener('change', draw);
    showPlanets.addEventListener('change', draw);
    resetBtn.addEventListener('click', () => {
        rotX = 0; rotY = 0;
        latInput.value = 0;
        lonInput.value = 0;
        magFilter.value = 6;
        magValue.textContent = "6";
        showStars.checked = true;
        showPlanets.checked = true;
        draw();
    });
    helpBtn.addEventListener('click', () => {
        helpModal.style.display = "flex";
    });
    closeHelp.addEventListener('click', () => {
        helpModal.style.display = "none";
    });
    helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) helpModal.style.display = "none";
    });

    // Hide loading screen after first draw
    function hideLoading() {
        loading.style.display = "none";
    }

    // Initial draw and loading
    window.addEventListener('DOMContentLoaded', () => {
        draw();
        setTimeout(hideLoading, 400); // allow a short delay for effect
    });
</script>
</body>
</html>